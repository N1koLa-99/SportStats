<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заявки за потвърждение</title>
    <link rel="stylesheet" href="Status.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <a href="HomePage.html" class="home-button"> 
        <i class="fas fa-home"></i>
    </a>
    <div class="container">
        <h1>Чакащи заявки</h1>
        <div id="requests-container">
            <p>Зареждане на заявки...</p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userJson = localStorage.getItem("user");
            if (!userJson) {
                alert("Не сте влезли в профила си.");
                window.location.href = "Index.html";
                return;
            }
    
            const user = JSON.parse(userJson);
            if (user.roleID !== 2) {
                alert("Нямате права за достъп до тази страница.");
                window.location.href = "HomePage.html";
                return;
            }
    
            const requestsContainer = document.getElementById("requests-container");
            requestsContainer.innerHTML = "<p>Зареждане...</p>";
    
            try {
                const response = await fetch(`https://sportstatsapi.azurewebsites.net/api/users/pending/${user.clubID}`);
                if (!response.ok) throw new Error("Грешка при зареждане на заявки");
    
                const requests = await response.json();
                requestsContainer.innerHTML = "";
    
                if (requests.length === 0) {
                    requestsContainer.innerHTML = "<p>Няма чакащи заявки.</p>";
                    return;
                }
    
                requests.forEach(request => {
                    const requestElement = document.createElement("div");
                    requestElement.classList.add("request-item");
                    requestElement.innerHTML = `
                        <p><strong>${request.firstName} ${request.lastName}</strong></p>
                        <p>Email: ${request.email}</p>
                        <button class="approve" onclick="updateStatus(${request.id}, 'approved')">Одобри</button>
                        <button class="reject" onclick="updateStatus(${request.id}, 'rejected')">Отхвърли</button>
                    `;
                    requestsContainer.appendChild(requestElement);
                });
            } catch (error) {
                requestsContainer.innerHTML = "<p>Грешка при зареждане на заявки.</p>";
                console.error(error);
            }
        });
    
        async function updateStatus(userId, status) {
            const apiUrl = `https://sportstatsapi.azurewebsites.net/api/users/${status === "approved" ? "approve" : "reject"}/${userId}`;
    
            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });
    
                if (!response.ok) throw new Error("Грешка при актуализиране на статуса");
    
                alert("Успешно обновен статус!");
    
                // Не променяме localStorage.user, защото това е треньорът, не променя себе си
    
                window.location.reload();
            } catch (error) {
                console.error(error);
                alert("Грешка при обновяване на статуса.");
            }
        }
    </script>    
</body>
</html>